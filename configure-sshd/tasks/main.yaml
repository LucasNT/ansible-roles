---
- name: install dependencies
  become: true
  ansible.builtin.package:
    name: '{{item}}'
    state: present
  loop:
    - awk
- name: regenerate hosts keys
  include_tasks: hostKeys
  loop:
    - ed25519
    - ecdsa

- name: test if moduli needs to be rewrite
  become: true
  ansible.builtin.shell:
    chdir: /etc/ssh
    cmd: awk '$5 <= 3071' | wc -l
  register: moduliKeys
  changed_when: false

- name: edit moduli file
  become: true
  ansible.builtin.shell:
    chdir: /etc/ssh
    cmd: awk '$5 >= 3071'  moduli > moduli.save ; mv moduli.safe moduli
  when: (moduliKeys.stdout | int) > 0

- name:  copy new sshd to remote
  become: true
  ansible.builtin.copy:
    dest: /etc/ssh/
    src: sshd_config
  notify:
    - restart sshd
